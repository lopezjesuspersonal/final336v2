<!DOCTYPE html>
<html lang="en">

<head>
    <%- include("partials/head.ejs") %>
        <title>Search Results</title>
</head>

<body>
    <h1>Search Results</h1>
    <a href="/apiTest">Back to Search</a>

    <div class="results-container">
        <% data.forEach(item=> { %>
            <div class="result-card">
                <img src="<%= item.thumb %>" alt="<%= item.title %>">
                <h3>
                    <%= item.title %>
                </h3>
                <p>Year: <%= item.year %>
                </p>

                <button onclick="playSong('<%= item.title %>')">Play on YouTube</button>

                <% let parts=item.title.split(' - ');
                   let artist = parts.length > 1 ? parts[0] : ' Unknown'; let song=parts.length> 1 ?
                    parts.slice(1).join(' - ') : item.title;
                    %>

                    <form action="/add-favorite" method="POST" style="margin-top: 10px;">
                        <input type="hidden" name="songName" value="<%= song %>">
                        <input type="hidden" name="artistName" value="<%= artist %>">
                        <button type="submit">❤️</button>
                    </form>

                    <button onclick="openPlaylistModal('<%= song %>', '<%= artist %>')" style="margin-top: 5px;">
                        Add to Playlist
                    </button>
            </div>
            <% }); %>
    </div>

    <div id="playlistModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('playlistModal')">&times;</span>
            <h2>Select Playlist</h2>
            <select id="playlistSelect" style="width:100%; margin-bottom:15px; padding:5px;"></select>
            <button onclick="addToPlaylist()">Add</button>
        </div>
    </div>

    <div id="videoModal" class="modal-overlay">
        <div class="video-modal-content">
            <button class="video-close-btn" onclick="closeModal('videoModal')">&times;</button>
            <iframe id="youtubePlayer" style="width:100%; height:100%;" src="" frameborder="0"
                allow="autoplay; encrypted-media" allowfullscreen></iframe>
        </div>
    </div>

    <script>
        let currentSong = {};

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'videoModal') {
                document.getElementById('youtubePlayer').src = '';
            }
        }

        window.onclick = function (event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.style.display = 'none';
                if (event.target.id === 'videoModal') {
                    document.getElementById('youtubePlayer').src = '';
                }
            }
        }

        async function playSong(title) {
            let response = await fetch(`/youtube-search?q=${title}`);
            let data = await response.json();
            document.getElementById('youtubePlayer').src = `https://www.youtube.com/embed/${data.videoId}?autoplay=1`;
            document.getElementById('videoModal').style.display = 'flex';
        }

        async function openPlaylistModal(songName, artistName) {
            currentSong = { songName, artistName };
            let modal = document.getElementById('playlistModal');
            let select = document.getElementById('playlistSelect');

            select.innerHTML = '<option>Loading...</option>';
            modal.style.display = 'flex';

            try {
                let response = await fetch('/api/playlists');
                let playlists = await response.json();

                select.innerHTML = '';
                if (playlists.length === 0) {
                    select.innerHTML = '<option value="">No playlists found</option>';
                    return;
                }
                playlists.forEach(p => {
                    let playlistOption = document.createElement('option');
                    playlistOption.value = p.playlistId;
                    playlistOption.textContent = p.playlistName;
                    select.append(playlistOption);
                });
            } catch (error) {
                console.error(error);
                select.innerHTML = '<option>Error loading playlists</option>';
            }
        }

        async function addToPlaylist() {
            let playlistId = document.getElementById('playlistSelect').value;
            if (!playlistId) return alert('Please select a playlist');

            let response = await fetch('/add-to-playlist', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    playlistId,
                    songName: currentSong.songName,
                    artistName: currentSong.artistName
                })
            });
            let result = await response.json();
            if (result.success) {
                alert('Song added!');
                closeModal('playlistModal');
            } else {
                alert('Failed to add song.');
            }

        }
    </script>
</body>

</html>